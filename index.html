<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Brianna Chiu: Motion Designer</title>
<style>
body, html {
    margin: 0;
    font-size: 0px;
    font-family: Arial, sans-serif;
    overflow-x: hidden; /* Prevent horizontal scrolling */
    overflow-y: auto;   /* Allow vertical scrolling */
    display: flex;
    flex-direction: column;
    align-items: center;
    background-color: #ECECEC;
}
canvas {
    width: 4000px; /* Set canvas width manually */
    margin: 0 auto; /* Center the canvas horizontammmlly */
    display: block; /* Ensure proper centering */
}
</style>
<script src="https://unpkg.com/@rive-app/canvas@latest"></script>
</head>
<body>
<canvas id="riveCanvas"></canvas>
<div id="widthDisplay"></div>
<script>
    let riveInstance, widthNumInput;

    const preloadAllImages = async () => {
        const totalImages = 174; // 0 to 173
        const preloadedImages = [];
        let allImagesLoaded = false;

        console.log("Starting to preload images...");

        // Load and display first image immediately and separately
        try {
            console.log("Loading first frame...");
            const firstImagePath = `/assets/images/demo-reel-thumbnail/Reel gif_00000.png`;
            const firstResponse = await fetch(firstImagePath, { priority: 'high' }); // Set high priority for first image
            const firstArrayBuffer = await firstResponse.arrayBuffer();
            preloadedImages[0] = new Uint8Array(firstArrayBuffer);
            console.log("First frame loaded successfully!");

            // Start loading remaining images in the background
            const loadRemainingImages = async () => {
                for (let i = 1; i < totalImages; i++) {
                    const paddedIndex = i.toString().padStart(5, "0");
                    const imagePath = `/assets/images/demo-reel-thumbnail/Reel gif_${paddedIndex}.png`;
                    
                    try {
                        const response = await fetch(imagePath);
                        const arrayBuffer = await response.arrayBuffer();
                        preloadedImages[i] = new Uint8Array(arrayBuffer);
                        console.log(`Preloaded image ${paddedIndex}`);
                    } catch (err) {
                        console.error(`Failed to load image ${paddedIndex}:`, err);
                    }
                }
                
                console.log("All images preloaded!");
                allImagesLoaded = true;
            };

            // Start loading remaining images without waiting
            loadRemainingImages();

            // Return immediately after first image is loaded
            return { preloadedImages, allImagesLoaded };

        } catch (err) {
            console.error("Failed to load first frame:", err);
            return { preloadedImages: null, allImagesLoaded: false };
        }
    };

    // Load a demo reel image
    const loadDemoReelImage = (asset, imageIndex) => {
        const imagePath = `/assets/images/demo-reel-thumbnail/Reel gif_${imageIndex.toString().padStart(5, "0")}.png`;
        console.log(`Attempting to load image: ${imagePath}`);
        return fetch(imagePath)
            .then(async (res) => {
                if (res.ok) {
                    console.log(`Successfully loaded image ${imageIndex}`);
                    const arrayBuffer = await res.arrayBuffer();
                    const image = await rive.decodeImage(new Uint8Array(arrayBuffer));
                    asset.setRenderImage(image);
                    image.unref();
                } else {
                    console.error(`Image load failed for index: ${imageIndex}, Status: ${res.status}`);
                }
            })
            .catch((err) => console.error(`Error loading image ${imageIndex}:`, err));
    };

    // Load all demo reel images
    const loadAllDemoReelImages = (asset) => {
        for (let i = 0; i <= 173; i++) {
            loadDemoReelImage(asset, i);
        }
    };

    function updateCanvasHeight() {
        const browserWidth = window.innerWidth;
        const canvas = document.getElementById('riveCanvas');
        const widthDisplay = document.getElementById('widthDisplay');

        widthDisplay.innerText = browserWidth + ' px';

        // Update Rive input if available
        if (widthNumInput) {
            widthNumInput.value = browserWidth;
        }

        // Update canvas height based on breakpoint
        if (browserWidth >= 1500) {
            canvas.style.height = '2205px'; // wide height
        } else {
            canvas.style.height = '3054px'; // skinny height
        }

        // Ensure Rive redraws on canvas resize
        if (riveInstance) {
            riveInstance.resizeDrawingSurfaceToCanvas();
        }
    }

    // function onRiveEventReceived(riveEvent) {
    //     const eventData = riveEvent.data;
    //     if (eventData.type === rive.RiveEventType.OpenUrl) {
    //         console.log("Event triggered:", eventData.name);
    //         console.log("Opening URL:", eventData.url);
            
    //         // Open the URL in a new tab
    //         window.open(eventData.url, "_blank");


    //     }
    // }

    function onRiveEventReceived(riveEvent) {
    const eventData = riveEvent.data;

    if (eventData.type === rive.RiveEventType.OpenUrl) {
        console.log("Event triggered:", eventData.name);

        switch (eventData.name) {
            case "Email":
                console.log("Opening Email");
                window.open("https://mail.google.com/mail/u/0/?fs=1&to=bri.mograph@gmail.com&su=Hi%20Bri!&body=You%27re%20so%20cool%20and%20I%27m%20so%20cool.%20We%20should%20work%20together!&tf=cm", "_blank");
                break;
            case "Resume":
                console.log("Opening Resume");
                window.open("https://drive.google.com/file/d/1Un9slfnD87eTaGfLCBiulZFgyjUqh061/view?usp=drive_link", "_blank");
                break;
            case "Demo-Reel":
                console.log("Navigating to Demo Reel");
                window.location.href = "pages/demo-reel.html";
                break;
            case "contact":
                console.log("Navigating to Contact");
                window.location.href = "/contact.html";
                break;
            case "externalLink":
                console.log("Opening External Link:", eventData.url);
                window.open(eventData.url, "_blank");
                break;
            default:
                console.log("Default action: Opening URL");
                window.open(eventData.url, "_blank");
        }
    }
}



    // Initialize Rive with preloaded images
    let preloadedImages = null;
    let allImagesLoaded = false;
    preloadAllImages().then(({ preloadedImages: images, allImagesLoaded: loaded }) => {
        preloadedImages = images;
        allImagesLoaded = loaded;
        
        riveInstance = new rive.Rive({
            src: 'layouts.riv',
            canvas: document.getElementById('riveCanvas'),
            autoplay: true,
            artboard: 'Site', // Ensure this artboard name is correct
            stateMachines: 'State Machine 1', // Ensure this state machine name is correct
            assetLoader: (asset, bytes) => {
                console.log("Asset loading:", {
                    name: asset.name,
                    fileExtension: asset.fileExtension,
                    cdnUuid: asset.cdnUuid,
                    isFont: asset.isFont,
                    isImage: asset.isImage,
                    bytes,
                });

                if (asset.isImage) {
                    if (asset.name === 'profile') {
                        return false;
                    }

                    // Check if first frame is available
                    if (!preloadedImages || !preloadedImages[0]) {
                        console.error("First frame not available yet");
                        return false;
                    }

                    // Immediately decode and display first frame
                    console.log("Setting first frame...");
                    rive.decodeImage(preloadedImages[0])
                        .then(image => {
                            asset.setRenderImage(image);
                            image.unref();
                            console.log("First frame set successfully!");
                            
                            const startSequence = () => {
                                if (allImagesLoaded) {
                                    console.log("Starting animation sequence...");
                                    let currentIndex = 1;
                                    
                                    const playSequence = async () => {
                                        if (currentIndex < preloadedImages.length) {
                                            const nextImage = await rive.decodeImage(preloadedImages[currentIndex]);
                                            asset.setRenderImage(nextImage);
                                            nextImage.unref();
                                            currentIndex++;
                                            await new Promise(resolve => setTimeout(resolve, 50));
                                            requestAnimationFrame(playSequence);
                                        }
                                    };

                                    requestAnimationFrame(playSequence);
                                } else {
                                    setTimeout(startSequence, 100);
                                }
                            };

                            setTimeout(startSequence, 100);
                        })
                        .catch(err => {
                            console.error("Error setting first frame:", err);
                        });

                    return true;
                }
                return false;
            },
            onLoad: () => {
                const inputs = riveInstance.stateMachineInputs('State Machine 1'); // Ensure this state machine name is correct
                widthNumInput = inputs.find(i => i.name === 'width num'); // Ensure this input name is correct
                riveInstance.resizeDrawingSurfaceToCanvas();

                // Update canvas height on load and resize
                updateCanvasHeight();
                window.onresize = updateCanvasHeight;
            }
        });

        // Listen for Rive Events
        riveInstance.on(rive.EventType.RiveEvent, onRiveEventReceived);
    });
</script>
</body>
</html>
